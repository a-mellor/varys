require_relative 'result.rb'

class Widgets

  def self.do_widget_search(query_string)
    widgets = {}

    actions = {
      # insert new call words here (as symbols), and the functions they call (declared below)
      # weather: do_weather_search,
      tube: do_tube_search,
      underground: do_tube_search,
      status: do_tube_search,
      example: do_example_search
    }

    actions.each do |key, value|
      if query_string.include?(key.to_s)
        widgets[key] = value
      end
    end

    # declare any widgets here that run on any query
    widgets[:wikipedia] = do_wikipedia_search(query_string)

    widgets
  end

  private

  def self.do_wikipedia_search(query_string)
    return [] if query_string == ""
    url = "https://en.wikipedia.org/w/api.php?action=opensearch&search=#{query_string}&limit=1&namespace=0&format=json"
    response = RestClient.get(url)
    prettify_wikipedia_json(JSON.parse(response))
  end

  def self.do_tube_search
    url = "https://api.tfl.gov.uk/line/mode/tube,overground,dlr,tflrail/status"
    response = RestClient::Request.execute(:url => url, :method => :get, :verify_ssl => false)
    JSON.parse(response)
    # [{"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"bakerloo", "name"=>"Bakerloo", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.847Z", "modified"=>"2016-07-27T11:46:02.847Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Bakerloo&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"central", "name"=>"Central", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.863Z", "modified"=>"2016-07-27T11:46:02.863Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Central&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"circle", "name"=>"Circle", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.94Z", "modified"=>"2016-07-27T11:46:02.94Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Circle&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"district", "name"=>"District", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.957Z", "modified"=>"2016-07-27T11:46:02.957Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=District&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"dlr", "name"=>"DLR", "modeName"=>"dlr", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.987Z", "modified"=>"2016-07-27T11:46:02.987Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=DLR&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"hammersmith-city", "name"=>"Hammersmith & City", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:03.003Z", "modified"=>"2016-07-27T11:46:03.003Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Hammersmith & City&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"jubilee", "name"=>"Jubilee", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:03.003Z", "modified"=>"2016-07-27T11:46:03.003Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Jubilee&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"london-overground", "name"=>"London Overground", "modeName"=>"overground", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.817Z", "modified"=>"2016-07-27T11:46:02.817Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "lineId"=>"london-overground", "statusSeverity"=>5, "statusSeverityDescription"=>"Part Closure", "reason"=>"LONDON OVERGROUND: Monday 1 to Friday 5 August, no service between Highbury & Islington and Shadwell, or between Surrey Quays and New Cross. Replacement buses operate between Dalston Kingsland (for North London Line connections) and Shadwell. For New Cross, please walk from New Cross Gate.", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[{"$type"=>"Tfl.Api.Presentation.Entities.ValidityPeriod, Tfl.Api.Presentation.Entities", "fromDate"=>"2016-08-01T04:30:00Z", "toDate"=>"2016-08-06T01:29:00Z", "isNow"=>false}], "disruption"=>{"$type"=>"Tfl.Api.Presentation.Entities.Disruption, Tfl.Api.Presentation.Entities", "category"=>"PlannedWork", "categoryDescription"=>"PlannedWork", "description"=>"LONDON OVERGROUND: Monday 1 to Friday 5 August, no service between Highbury & Islington and Shadwell, or between Surrey Quays and New Cross. Replacement buses operate between Dalston Kingsland (for North London Line connections) and Shadwell. For New Cross, please walk from New Cross Gate.", "additionalInfo"=>"Service W: Dalston Kingsland - Dalston Junction - Haggerston - Hoxton - Shoreditch High Street - Whitechapel - ShadwellOr use London Underground service via all reasonable routes (entrance / exit at Canada Water and Stratford stations only)", "created"=>"2016-08-01T08:40:00Z", "affectedRoutes"=>[], "affectedStops"=>[], "closureText"=>"partClosure"}}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=London Overground&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"metropolitan", "name"=>"Metropolitan", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.863Z", "modified"=>"2016-07-27T11:46:02.863Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "lineId"=>"metropolitan", "statusSeverity"=>3, "statusSeverityDescription"=>"Part Suspended", "reason"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[{"$type"=>"Tfl.Api.Presentation.Entities.ValidityPeriod, Tfl.Api.Presentation.Entities", "fromDate"=>"2016-08-02T17:14:35Z", "toDate"=>"2016-08-02T20:14:35Z", "isNow"=>true}], "disruption"=>{"$type"=>"Tfl.Api.Presentation.Entities.Disruption, Tfl.Api.Presentation.Entities", "category"=>"RealTime", "categoryDescription"=>"RealTime", "description"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "affectedRoutes"=>[], "affectedStops"=>[], "isBlocking"=>true, "closureText"=>"partSuspended"}}, {"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "lineId"=>"metropolitan", "statusSeverity"=>6, "statusSeverityDescription"=>"Severe Delays", "reason"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[{"$type"=>"Tfl.Api.Presentation.Entities.ValidityPeriod, Tfl.Api.Presentation.Entities", "fromDate"=>"2016-08-02T17:14:36Z", "toDate"=>"2016-08-03T01:29:00Z", "isNow"=>true}], "disruption"=>{"$type"=>"Tfl.Api.Presentation.Entities.Disruption, Tfl.Api.Presentation.Entities", "category"=>"RealTime", "categoryDescription"=>"RealTime", "description"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "affectedRoutes"=>[], "affectedStops"=>[], "closureText"=>"severeDelays"}}, {"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "lineId"=>"metropolitan", "statusSeverity"=>9, "statusSeverityDescription"=>"Minor Delays", "reason"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[{"$type"=>"Tfl.Api.Presentation.Entities.ValidityPeriod, Tfl.Api.Presentation.Entities", "fromDate"=>"2016-08-02T17:14:36Z", "toDate"=>"2016-08-03T01:29:00Z", "isNow"=>true}], "disruption"=>{"$type"=>"Tfl.Api.Presentation.Entities.Disruption, Tfl.Api.Presentation.Entities", "category"=>"RealTime", "categoryDescription"=>"RealTime", "description"=>"Metropolitan Line: No service Baker Street to Aldgate. SEVERE DELAYS Harrow on the Hill to Baker Street while we fix a signal failure at Harrow on the Hill, MINOR DELAYS on the rest of the line. Chiltern and London Buses accepting valid London Underground tickets via any reasonable route. ", "affectedRoutes"=>[], "affectedStops"=>[], "isWholeLine"=>true, "closureText"=>"minorDelays"}}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Metropolitan&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"northern", "name"=>"Northern", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.923Z", "modified"=>"2016-07-27T11:46:02.923Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Northern&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"piccadilly", "name"=>"Piccadilly", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.893Z", "modified"=>"2016-07-27T11:46:02.893Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Piccadilly&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"tfl-rail", "name"=>"TfL Rail", "modeName"=>"tflrail", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.987Z", "modified"=>"2016-07-27T11:46:02.987Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=TfL Rail&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"victoria", "name"=>"Victoria", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.94Z", "modified"=>"2016-07-27T11:46:02.94Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Victoria&serviceTypes=Regular"}]}, {"$type"=>"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities", "id"=>"waterloo-city", "name"=>"Waterloo & City", "modeName"=>"tube", "disruptions"=>[], "created"=>"2016-07-27T11:46:02.91Z", "modified"=>"2016-07-27T11:46:02.91Z", "lineStatuses"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities", "id"=>0, "statusSeverity"=>10, "statusSeverityDescription"=>"Good Service", "created"=>"0001-01-01T00:00:00", "validityPeriods"=>[]}], "routeSections"=>[], "serviceTypes"=>[{"$type"=>"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities", "name"=>"Regular", "uri"=>"/Line/Route?ids=Waterloo & City&serviceTypes=Regular"}]}]
  end

  def self.do_example_search
    "HEY I'M AN EXAMPLE"
  end

  def self.prettify_wikipedia_json(json)
    description = json[2][0] ? json[2][0] : ""
    output = [Result.new(title: json[1][0], url: json[3][0], description: description)]

    output_description = output.first.description
    return [] if output_description.include? 'may refer to'

    output
  end
end
